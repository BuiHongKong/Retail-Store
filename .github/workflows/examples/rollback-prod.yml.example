# Copy vào prod repo dưới tên .github/workflows/rollback-prod.yml
# Manual: chọn image tag cũ để deploy lại lên prod (không build mới).
name: Rollback Prod
on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g. prod-abc1234 or v1.0.0)'
        required: true
jobs:
  rollback:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
      ECS_CLUSTER: ${{ vars.ECS_CLUSTER_PROD || 'retail-prod' }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Rollback ECS services to tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          echo "Rolling back to tag: $TAG"
          # Cập nhật task definition để dùng image tag này, rồi update-service. Hoặc nếu task definition đã dùng tag động, chỉ cần update-service với task definition mới.
          # Ví dụ: aws ecs update-service ... (task definition phải được tạo trước với image tag $TAG; hoặc dùng AWS CLI register-task-definition rồi update-service).
          for svc in frontend main cart checkout auth admin; do
            aws ecs update-service --cluster $ECS_CLUSTER --service $svc --force-new-deployment --region $AWS_REGION --output text --query 'service.serviceName' || true
          done
          echo "Đảm bảo task definition của từng service trỏ image tag $TAG (sửa trong AWS Console hoặc Terraform rồi chạy lại workflow)."
      - name: Summary
        run: |
          echo "## Rollback requested to ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Kiểm tra ECS Console để task definition đang dùng đúng image tag." >> $GITHUB_STEP_SUMMARY
