# Run k6 load test against production to generate metrics for Grafana (prod).
# Set secret PROD_URL (e.g. http://your-prod-alb-dns) and optionally enable schedule.
name: Load test (prod)
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
jobs:
  k6-load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PROD_URL
        run: |
          if [ -z "${{ secrets.PROD_URL }}" ]; then
            echo "::warning::PROD_URL secret not set. Add it in repo Settings â†’ Secrets to run load test against prod."
            echo "SKIP_K6=true" >> $GITHUB_ENV
          else
            echo "BASE_URL=${{ secrets.PROD_URL }}" >> $GITHUB_ENV
          fi

      - name: Run k6
        if: env.SKIP_K6 != 'true'
        uses: grafana/k6-action@v0.4.0
        with:
          filename: scripts/load/k6-prod.js
          cloud: false
        env:
          BASE_URL: ${{ secrets.PROD_URL }}
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Load test (prod) finished" >> $GITHUB_STEP_SUMMARY
          echo "Set \`PROD_URL\` secret to run against prod ALB. Metrics in Grafana at \`/grafana\` (prod)." >> $GITHUB_STEP_SUMMARY
